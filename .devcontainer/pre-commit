#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03
# Modified for monorepo: runs pre-commit in each package directory

# start templated
INSTALL_PYTHON=/home/klapaucius/.local/share/pipx/venvs/pre-commit/bin/python
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit)
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"

# Store workspace root (go up two levels from .git/hooks to workspace root)
WORKSPACE_ROOT="$(cd "$HERE/../.." && pwd)"

# Track overall exit code
OVERALL_EXIT_CODE=0

# Get list of staged files from git
mapfile -t STAGED_FILES < <(git diff --cached --name-only --diff-filter=ACM)

# Find all directories containing pyproject.toml and run pre-commit in each
for pkg_dir in $(find "$WORKSPACE_ROOT" -maxdepth 2 -name 'pyproject.toml' -exec dirname {} \; | sort); do
    # Skip if no .pre-commit-config.yaml exists in this directory
    if [ ! -f "$pkg_dir/.pre-commit-config.yaml" ]; then
        continue
    fi
    
    # Get relative path from workspace root
    pkg_rel_path="${pkg_dir#$WORKSPACE_ROOT/}"
    
    # Filter staged files to only those in this package directory and convert to relative paths
    pkg_files=()
    for file in "${STAGED_FILES[@]}"; do
        # Check if file is within this package directory
        if [[ "$file" == "$pkg_rel_path"/* ]]; then
            # Convert to path relative to package directory
            relative_file="${file#$pkg_rel_path/}"
            pkg_files+=("$relative_file")
        fi
    done
    
    # Skip if no files in this package are staged
    if [ ${#pkg_files[@]} -eq 0 ]; then
        continue
    fi
    
    # Change to package directory
    cd "$pkg_dir" || continue
    
    # Run pre-commit with the appropriate Python/command
    # Use 'run' command with --files to specify which files to check
    if [ -x "$INSTALL_PYTHON" ]; then
        "$INSTALL_PYTHON" -mpre_commit run --files "${pkg_files[@]}"
        PKG_EXIT_CODE=$?
    elif command -v pre-commit > /dev/null; then
        pre-commit run --files "${pkg_files[@]}"
        PKG_EXIT_CODE=$?
    else
        echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
        exit 1
    fi
    
    # Capture failure but continue to run other packages
    if [ $PKG_EXIT_CODE -ne 0 ]; then
        OVERALL_EXIT_CODE=$PKG_EXIT_CODE
    fi
done

# Return to workspace root and exit with aggregated code
cd "$WORKSPACE_ROOT"
exit $OVERALL_EXIT_CODE
