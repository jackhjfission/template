name: Run Tests

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  discover-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find-packages.outputs.packages }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for change detection
    
    - name: Find packages
      id: find-packages
      run: |
        # Find all directories with pyproject.toml
        packages=$(find . -maxdepth 2 -name 'pyproject.toml' -exec dirname {} \; | while read dir; do
          # Remove leading ./
          echo "${dir#./}"
        done | jq -R -s -c 'split("\n") | map(select(length > 0))')
        
        echo "packages=$packages" >> $GITHUB_OUTPUT
        echo "Found packages: $packages"

  detect-changes:
    runs-on: ubuntu-latest
    needs: discover-packages
    outputs:
      changed-packages: ${{ steps.filter-packages.outputs.changed-packages }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Determine comparison base
      id: comparison-base
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # For PRs, compare against the base branch
          echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
        else
          # For pushes to main, compare against the commit before the push
          echo "base=${{ github.event.before }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Filter packages with changes
      id: filter-packages
      run: |
        base_commit="${{ steps.comparison-base.outputs.base }}"
        current_commit="${{ github.sha }}"
        
        packages='${{ needs.discover-packages.outputs.packages }}'
        changed_packages=[]
        
        echo "Comparing $base_commit...$current_commit"
        
        # Get list of changed files
        changed_files=$(git diff --name-only "$base_commit" "$current_commit")
        
        # Check each package for changes
        for pkg in $(echo "$packages" | jq -r '.[]'); do
          # Check if any changed file is in this package directory
          if echo "$changed_files" | grep -q "^$pkg/"; then
            changed_packages=$(echo "$changed_packages" | jq --arg pkg "$pkg" '. + [$pkg]')
            echo "Package $pkg has changes"
          fi
        done
        
        # Compact JSON to single line for GITHUB_OUTPUT
        changed_packages_compact=$(echo "$changed_packages" | jq -c '.')
        echo "changed-packages=$changed_packages_compact" >> $GITHUB_OUTPUT
        echo "Changed packages: $changed_packages_compact"

  test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-packages != '[]'
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.changed-packages) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Load cached venv for ${{ matrix.package }}
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: ${{ matrix.package }}/.venv
        key: venv-${{ matrix.package }}-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', matrix.package)) }}
    
    - name: Install dependencies for ${{ matrix.package }}
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      working-directory: ${{ matrix.package }}
      run: |
        poetry install --all-extras --all-groups
    
    - name: Run tests for ${{ matrix.package }}
      working-directory: ${{ matrix.package }}
      run: |
        poetry run pytest -v
