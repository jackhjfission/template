name: Pre-commit Checks

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  discover-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find-packages.outputs.packages }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for change detection
    
    - name: Find packages
      id: find-packages
      run: |
        # Find all directories with both pyproject.toml and .pre-commit-config.yaml
        packages=$(find . -maxdepth 2 -name 'pyproject.toml' -exec dirname {} \; | while read dir; do
          if [ -f "$dir/.pre-commit-config.yaml" ]; then
            # Remove leading ./
            echo "${dir#./}"
          fi
        done | jq -R -s -c 'split("\n") | map(select(length > 0))')
        
        echo "packages=$packages" >> $GITHUB_OUTPUT
        echo "Found packages: $packages"

  detect-changes:
    runs-on: ubuntu-latest
    needs: discover-packages
    outputs:
      changed-packages: ${{ steps.filter-packages.outputs.changed-packages }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Determine comparison base
      id: comparison-base
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # For PRs, compare against the base branch
          echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
        else
          # For pushes to main, compare against the commit before the push
          echo "base=${{ github.event.before }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Filter packages with changes
      id: filter-packages
      run: |
        base_commit="${{ steps.comparison-base.outputs.base }}"
        current_commit="${{ github.sha }}"
        
        packages='${{ needs.discover-packages.outputs.packages }}'
        changed_packages=[]
        
        echo "Comparing $base_commit...$current_commit"
        
        # Get list of changed files
        changed_files=$(git diff --name-only "$base_commit" "$current_commit")
        
        # Check each package for changes
        for pkg in $(echo "$packages" | jq -r '.[]'); do
          # Check if any changed file is in this package directory
          if echo "$changed_files" | grep -q "^$pkg/"; then
            changed_packages=$(echo "$changed_packages" | jq --arg pkg "$pkg" '. + [$pkg]')
            echo "Package $pkg has changes"
          fi
        done
        
        # Compact JSON to single line for GITHUB_OUTPUT
        changed_packages_compact=$(echo "$changed_packages" | jq -c '.')
        echo "changed-packages=$changed_packages_compact" >> $GITHUB_OUTPUT
        echo "Changed packages: $changed_packages_compact"

  pre-commit:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-packages != '[]'
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.changed-packages) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install pre-commit with pipx
      run: |
        pipx install pre-commit
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Load cached venv for ${{ matrix.package }}
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: ${{ matrix.package }}/.venv
        key: venv-${{ matrix.package }}-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', matrix.package)) }}
    
    - name: Install dependencies for ${{ matrix.package }}
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      working-directory: ${{ matrix.package }}
      run: |
        poetry install --all-extras --all-groups
    
    - name: Generate mypy.ini for ${{ matrix.package }}
      working-directory: ${{ matrix.package }}
      run: |
        PYTHON_PATH=$(poetry run which python)
        cat > mypy.ini << EOF
        [mypy]
        explicit_base_packages = true
        python_executable = $PYTHON_PATH
        EOF
        echo "Generated mypy.ini with python_executable=$PYTHON_PATH"
    
    - name: Cache pre-commit environments for ${{ matrix.package }}
      uses: actions/cache@v3
      with:
        path: ~/.cache/pre-commit
        key: pre-commit-${{ matrix.package }}-${{ runner.os }}-${{ hashFiles(format('{0}/.pre-commit-config.yaml', matrix.package)) }}
    
    - name: Run pre-commit hooks for ${{ matrix.package }}
      working-directory: ${{ matrix.package }}
      run: |
        # Get all tracked files in this package directory
        files=$(git ls-files)
        # Run pre-commit only on files in this package
        pre-commit run --files $files --show-diff-on-failure
    
    - name: Check if pre-commit hooks modified files in ${{ matrix.package }}
      working-directory: ${{ matrix.package }}
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "Pre-commit hooks modified files in ${{ matrix.package }}."
          echo "Please run 'cd ${{ matrix.package }} && poetry run pre-commit run --all-files' locally and commit the changes."
          git status
          git diff
          exit 1
        fi
